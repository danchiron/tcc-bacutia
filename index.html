<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Vida Secreta das Rochas - TCC Pablo Salvato</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,400&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #EFEBE9; color: #3E2723; }
        h1, h2, h3, h4 { font-family: 'Merriweather', serif; }
        
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 350px;
            max-height: 400px;
        }

        .chat-message {
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 8px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }
        .user-msg {
            background-color: #D7CCC8;
            align-self: flex-end;
            margin-left: auto;
            text-align: left;
        }
        .ai-msg {
            background-color: #FFCCBC;
            align-self: flex-start;
            border-left: 4px solid #B71C1C;
        }
        .font-comic { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; }
        #kids-chat-output .chat-message { white-space: pre-line; }

        .active-tab {
            background-color: #5D4037;
            color: white;
            border-bottom: 4px solid #B71C1C;
        }
        .inactive-tab {
            background-color: white;
            color: #5D4037;
            border-bottom: 4px solid transparent;
        }

        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .typing-indicator::after {
            content: '...';
            animation: ellipsis 1.5s infinite;
        }
        @keyframes ellipsis {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-[#5D4037] text-white py-8 shadow-lg">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl md:text-5xl font-bold mb-2 text-[#FFCCBC]">O Segredo das Pedras da Bacutia</h1>
            <p class="text-lg md:text-xl font-light text-gray-200 uppercase tracking-widest">Caracteriza√ß√£o Petrogr√°fica e Evolu√ß√£o Textural da Granada</p>
            <p class="text-sm mt-4 opacity-80 italic">Uma jornada pelas profundezas de Guarapari-ES</p>
            <div class="mt-4 flex flex-col md:flex-row justify-center items-center gap-2 md:gap-8 opacity-90">
                <p>Autor: <span class="font-bold">Pablo de Oliveira Salvato</span></p>
                <p>Orienta√ß√£o: <span class="font-bold">Prof.¬™ Dr.¬™ Marilane Gonzaga de Melo</span></p>
            </div>
        </div>
    </header>

    <nav class="sticky top-0 z-50 bg-[#EFEBE9] shadow-md border-b border-gray-300">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap justify-center space-x-1 py-3">
                <button onclick="switchTab('general')" id="tab-general" class="px-4 md:px-8 py-3 rounded-t-lg font-bold transition-all active-tab shadow-sm">
                    Geral
                </button>
                <button onclick="switchTab('academic')" id="tab-academic" class="px-4 md:px-8 py-3 rounded-t-lg font-bold transition-all inactive-tab shadow-sm">
                    Acad√™mico
                </button>
                <button onclick="switchTab('kids')" id="tab-kids" class="px-4 md:px-8 py-3 rounded-t-lg font-bold transition-all inactive-tab shadow-sm">
                    Interativo
                </button>
                <button onclick="switchTab('infografico')" id="tab-infografico" class="px-4 md:px-8 py-3 rounded-t-lg font-bold transition-all inactive-tab shadow-sm">
                    Infogr√°fico
                </button>
            </div>
        </div>
    </nav>

    <main id="content-area" class="flex-grow container mx-auto px-4 py-8">
        
        <section id="view-general" class="fade-in space-y-12">
            <div class="max-w-4xl mx-auto text-center bg-white p-8 rounded-xl shadow-md border-t-4 border-[#8D6E63]">
                <h2 class="text-3xl font-bold text-[#5D4037] mb-4">A Ci√™ncia por tr√°s da Beleza</h2>
                <p class="text-lg text-gray-700 leading-relaxed">
                    A Praia da Bacutia n√£o √© s√≥ cen√°rio de f√©rias: √© uma cicatriz geol√≥gica da colis√£o entre continentes que ajudou a erguer, no passado, uma cadeia de montanhas colossal no leste do Brasil.
                </p>
                <p class="text-base text-gray-700 leading-relaxed mt-4 text-left">
                    Cada passo sobre essas pedras √© uma viagem no tempo. Voc√™ est√° pisando nas ra√≠zes profundas de uma antiga montanha ‚Äî um verdadeiro ‚ÄúHimalaia brasileiro‚Äù ‚Äî forjada por press√µes gigantescas, calor extremo e rios de rocha parcialmente derretida.
                </p>
                <p class="text-base text-gray-700 leading-relaxed mt-4 text-left">
                    Aqui, a Terra conta uma hist√≥ria de fogo e renascimento: sedimentos viraram rocha, a rocha quase virou magma, cristais nasceram no cora√ß√£o da crosta e, milh√µes de anos depois, tudo voltou √† superf√≠cie para ser revelado entre o mar, o sol e a areia de Guarapari.
                </p>
            </div>

            <div class="grid md:grid-cols-2 gap-8 items-center">
                <div class="bg-white p-4 rounded-xl shadow-xl border border-gray-200">
                    <h3 class="text-xl font-bold text-[#5D4037] mb-3">V√≠deo da apresenta√ß√£o</h3>
                    <div class="relative w-full overflow-hidden rounded-lg" style="padding-top: 56.25%;">
                        <iframe
                            class="absolute top-0 left-0 w-full h-full"
                            src="https://drive.google.com/file/d/1EQX99wclcQy_10unqbkrfTINQu24w8AN/preview"
                            title="Apresenta√ß√£o do TCC - Pablo Salvato"
                            allow="autoplay"
                            loading="lazy">
                        </iframe>
                    </div>
                    <p class="text-sm text-gray-600 mt-3">Se o v√≠deo n√£o carregar automaticamente, abra o link no Google Drive.</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-2xl font-bold text-[#5D4037] mb-4">Como as rochas mudaram?</h3>
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="bg-[#B71C1C] text-white w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold">1</div>
                            <p class="text-gray-700"><strong>Lama:</strong> Tudo come√ßou como lama no oceano antigo.</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="bg-[#B71C1C] text-white w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold">2</div>
                            <p class="text-gray-700"><strong>Calor:</strong> A rocha foi "cozinhada" a 800¬∞C nas profundezas.</p>
                        </div>
                        <div class="flex gap-4">
                            <div class="bg-[#B71C1C] text-white w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center font-bold">3</div>
                            <p class="text-gray-700"><strong>Cristal:</strong> Nasceram as Granadas, as "joias" da rocha.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-academic" class="hidden fade-in space-y-12">
            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-8 border-[#B71C1C]">
                        <h3 class="text-2xl font-bold text-[#5D4037] mb-4">Resumo Acad√™mico</h3>
                        <p class="text-gray-700 text-justify">
                            Paragnaisses migmatizados da Praia da Bacutia revelam fus√£o por desidrata√ß√£o da biotita
                            (<strong>Bt + Qtz + Pl ‚Üí Grt<sub>1</sub> + Kfs + Melt</strong>).
                            O pico metam√≥rfico foi atingido em ~800‚Äì850 ¬∞C e ~7,5 kbar, em condi√ß√µes de f√°cies granulito.
                        </p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-8 border-[#8D6E63] space-y-3">
                        <h3 class="text-2xl font-bold text-[#5D4037]">Narrativa Petrogen√©tica (texto-base do TCC)</h3>
                        <p class="text-gray-700 text-justify">
                            O prot√≥lito pel√≠tico dos paragnaisses da Bacutia foi progressivamente soterrado durante a
                            converg√™ncia neoproterozoica associada ao Or√≥geno Ara√ßua√≠. O aumento acoplado de temperatura
                            e press√£o levou √† desestabiliza√ß√£o da biotita, promovendo fus√£o parcial por desidrata√ß√£o e
                            gera√ß√£o de melt silic√°tico, K-feldspato e granada. Nesse est√°gio, a granada <strong>Grt<sub>1</sub></strong>
                            tende a registrar inclus√µes minerais e microestruturas herdadas da matriz, compat√≠veis com
                            crescimento pr√≥grado em ambiente de alto grau.
                        </p>
                        <p class="text-gray-700 text-justify">
                            A condi√ß√£o de pico, em ~800‚Äì850 ¬∞C e ~7,5 kbar, indica metamorfismo em f√°cies granulito em
                            profundidades crustais intermedi√°rias (~25 km). Ap√≥s o √°pice t√©rmico, o sistema evoluiu para
                            exuma√ß√£o e resfriamento, com cristaliza√ß√£o progressiva do melt remanescente e reequil√≠brios
                            texturais. Nesse contexto, a granada <strong>Grt<sub>2</sub></strong> pode ocorrer mais limpa, com menor carga
                            de inclus√µes, refletindo est√°gios tardios de crescimento e/ou recristaliza√ß√£o.
                        </p>
                        <p class="text-gray-700 text-justify">
                            Na trajet√≥ria retr√≥grada, a forma√ß√£o de coroas e bordas de <strong>cordierita</strong> ao redor da granada
                            expressa descompress√£o e hidrata√ß√£o relativa do sistema. Assim, a associa√ß√£o Grt‚ÄìBt‚ÄìSil com
                            Cord retrograda preserva um registro integrado de aquecimento colisional, anatexia e evolu√ß√£o
                            p√≥s-pico, oferecendo uma base robusta para reconstru√ß√µes P‚ÄìT‚Äìt da hist√≥ria metam√≥rfica da
                            regi√£o de Guarapari-ES.
                        </p>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-white p-4 rounded-xl shadow-md h-[400px]">
                            <canvas id="mineralChart"></canvas>
                        </div>
                        <div class="bg-white p-4 rounded-xl shadow-md h-[400px]">
                            <canvas id="ptPathChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-[#EFEBE9] p-4 rounded-xl shadow-lg border-2 border-[#8D6E63] flex flex-col h-[600px]">
                    <h4 class="text-lg font-bold text-[#5D4037] mb-4">Chat de Pesquisa IA</h4>
                    <div id="academic-chat-output" class="flex-grow overflow-y-auto bg-white p-3 rounded-lg border flex flex-col gap-3 text-sm mb-4">
                        <div class="ai-msg chat-message">D√∫vidas t√©cnicas sobre o TCC? Pergunte aqui.</div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="academic-chat-input" placeholder="Ex: O que √© Grt1?" class="flex-grow p-2 rounded border focus:outline-none" onkeypress="handleEnter(event, 'academic')">
                        <button onclick="askGemini('academic')" class="bg-[#5D4037] text-white px-4 rounded-lg">‚û§</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-kids" class="hidden fade-in space-y-12">
            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl border-4 border-[#8D6E63]">
                    <h2 class="text-2xl font-bold text-center mb-6">Laborat√≥rio de Rochas</h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <label class="block font-bold">Temperatura</label>
                            <input type="range" id="tempSlider" min="1" max="100" value="10" class="w-full accent-red-600" oninput="updateRock()">
                            <p class="text-sm text-gray-700">Escala aproximada: <span id="tempValue" class="font-bold">260</span> ¬∞C</p>
                            <label class="block font-bold">Press√£o</label>
                            <input type="range" id="pressSlider" min="1" max="100" value="10" class="w-full accent-stone-700" oninput="updateRock()">
                            <p class="text-sm text-gray-700">Escala aproximada: <span id="pressValue" class="font-bold">1.7</span> kbar</p>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setRockPreset('low')" class="bg-stone-200 hover:bg-stone-300 px-2 py-2 rounded text-sm">Baixo grau</button>
                                <button onclick="setRockPreset('medium')" class="bg-amber-200 hover:bg-amber-300 px-2 py-2 rounded text-sm">M√©dio grau</button>
                                <button onclick="setRockPreset('peak')" class="bg-red-200 hover:bg-red-300 px-2 py-2 rounded text-sm">Pico Bacutia</button>
                                <button onclick="setRockPreset('retro')" class="bg-blue-200 hover:bg-blue-300 px-2 py-2 rounded text-sm">Retrograda√ß√£o</button>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                                <h4 class="font-bold" id="rock-status-title">Lama do Mar</h4>
                                <p class="text-sm" id="rock-status-desc">Arraste os controles!</p>
                                <div class="mt-3">
                                    <p class="text-xs uppercase tracking-wide text-gray-600">Fra√ß√£o de fus√£o parcial</p>
                                    <div class="w-full bg-blue-100 rounded-full h-3 mt-1 overflow-hidden">
                                        <div id="meltBar" class="h-3 bg-gradient-to-r from-amber-300 to-red-500 rounded-full" style="width: 0%"></div>
                                    </div>
                                    <p class="text-xs mt-1 text-gray-700" id="meltText">0% de melt</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 leading-relaxed">
                                Modelo educativo inspirado em trajet√≥rias P-T de metamorfismo regional (baixo grau ‚Üí anfibolito ‚Üí migmatito) e na condi√ß√£o de pico reportada no TCC (~800 ¬∞C / 7,5 kbar).
                            </p>
                        </div>
                        <div class="flex items-center justify-center">
                            <canvas id="rockCanvas" width="250" height="250" class="rounded-full bg-gray-50 shadow-inner"></canvas>
                        </div>
                    </div>
                </div>
                <div class="bg-[#FFF3E0] p-4 rounded-2xl shadow-xl border-4 border-[#FFAB91] flex flex-col h-[600px]">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-[#B71C1C] rounded-full mx-auto flex items-center justify-center text-3xl text-white">DG</div>
                        <h4 class="font-bold text-[#BF360C] mt-2">Dona Granada</h4>
                    </div>
                    <div id="kids-chat-output" class="flex-grow overflow-y-auto bg-white p-3 rounded-xl flex flex-col gap-3 mb-4 font-comic text-sm">
                        <div class="ai-msg chat-message">Ol√°! Sou a Dona Granada. üëµüî•
Temos dois jeitos de conversar: "Curta" (1‚Äì3 frases) ou "M√∫ltipla escolha" (A/B/C + resposta certa).
Escolha um modo e pergunte qualquer coisa, meu pedregulho!</div>
                    </div>
                    <div class="mb-3">
                        <label for="kids-response-style" class="block text-xs font-bold text-[#BF360C] mb-1">Estilo da resposta</label>
                        <select id="kids-response-style" class="w-full p-2 rounded-lg border-2 border-[#FFAB91] bg-white text-sm font-comic focus:outline-none">
                            <option value="short">Curta (1‚Äì3 frases)</option>
                            <option value="quiz">M√∫ltipla escolha (A/B/C + resposta correta)</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2">
                        <select id="kids-response-style-shortcut" class="p-2 rounded-xl border-2 border-[#FFAB91] font-comic text-[#5D4037] bg-white" onchange="document.getElementById('kids-response-style').value = this.value">
                            <option value="short">Resposta curtinha</option>
                            <option value="quiz">M√∫ltipla escolha</option>
                        </select>
                        <p class="text-xs text-[#6D4C41] font-comic px-1 self-center">Escolha o estilo antes de enviar a pergunta.</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="kids-chat-input" placeholder="Diz ol√°!" class="flex-grow p-3 rounded-full border-2 border-[#FFAB91] focus:outline-none font-comic" onkeypress="handleEnter(event, 'kids')">
                        <button onclick="askGemini('kids')" class="bg-[#BF360C] text-white w-12 h-12 rounded-full font-bold shadow-lg">OK</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-infografico" class="hidden fade-in space-y-8">
            <div class="max-w-5xl mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-200">
                <h2 class="text-3xl font-bold text-[#5D4037] text-center mb-2">Infogr√°fico</h2>
                <p class="text-center text-gray-700 mb-6">Anatexia em destaque</p>
                <img
                    src="assets/infografico-bacutia.png"
                    alt="Infogr√°fico sobre anatexia"
                    class="w-full h-auto rounded-xl border border-gray-300 shadow-sm"
                    loading="lazy"
                >
                <p class="text-xs text-gray-500 mt-3 text-center">
                    Imagem em alta resolu√ß√£o carregada localmente pelo arquivo <code>assets/infografico-bacutia.png</code> do projeto.
                </p>
                <div class="mt-6 grid gap-3 md:grid-cols-3 text-sm">
                    <p class="bg-[#EFEBE9] border border-[#D7CCC8] rounded-lg p-3 text-gray-800">
                        <strong>1. Prot√≥lito:</strong> No in√≠cio, era s√≥ areia + argila (lama) no fundo do mar, ainda sem virar rocha dura.
                    </p>
                    <p class="bg-[#FBE9E7] border border-[#FFCCBC] rounded-lg p-3 text-gray-800">
                        <strong>2. Pico/Fus√£o:</strong> A ~800 ¬∞C, a biotita (mica preta) ‚Äúquebrou‚Äù e gerou l√≠quido (magma) + granada.
                    </p>
                    <p class="bg-[#E8F5E9] border border-[#C8E6C9] rounded-lg p-3 text-gray-800">
                        <strong>3. Retrometamorfismo:</strong> No resfriamento e subida da rocha, a press√£o caiu e apareceu uma nova ‚Äúcasca‚Äù de cordierita.
                    </p>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-[#3E2723] text-[#D7CCC8] py-8 text-center border-t-4 border-[#B71C1C]">
        <p class="font-bold">UFES - Departamento de Geologia</p>
        <p class="text-xs opacity-50 mt-2">&copy; 2025 Pablo Salvato & Gemini AI</p>
    </footer>

    <script>
        const apiKey = "AIzaSyDcHaFb2wVSyxpodcoy6lr1_hW5TKAVQDI";
        const GEMINI_API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta';
        const PRIMARY_MODEL = 'gemini-2.0-flash';
        const FALLBACK_MODEL = 'gemini-1.5-flash';

        function switchTab(tabId) {
            ['general', 'academic', 'kids', 'infografico'].forEach(id => {
                document.getElementById(`view-${id}`).classList.add('hidden');
                document.getElementById(`tab-${id}`).classList.replace('active-tab', 'inactive-tab');
            });
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            document.getElementById(`tab-${tabId}`).classList.replace('inactive-tab', 'active-tab');
            if (tabId === 'academic') { mineralChart.resize(); ptPathChart.resize(); }
        }

        function handleEnter(e, mode) { if (e.key === 'Enter') askGemini(mode); }

        const TCC_CONTEXT = `
            Contexto do TCC: Pablo de Oliveira Salvato (UFES), tema "Caracteriza√ß√£o Petrogr√°fica e Evolu√ß√£o Textural da Granada em paragnaisse migmatizado da Bacutia (Guarapari-ES)".
            Pontos-chave: pico metam√≥rfico ~800 ¬∞C e ~7,5 kbar; trajet√≥ria pr√≥grada com fus√£o parcial; rea√ß√£o simplificada Bt + Qtz + Pl -> Grt + Kfs + melt; fase retr√≥grada com cristaliza√ß√£o do melt.
            Ao responder, mantenha o foco nesse TCC e, se algo n√£o estiver no contexto, diga que √© uma infer√™ncia.
        `;

        const SYSTEM_PROMPTS = {
            academic: `Voc√™ √© um assistente t√©cnico do TCC do Pablo Salvato. Responda com linguagem formal e objetiva para d√∫vidas acad√™micas. ${TCC_CONTEXT}`,
            kids: `Aja como a "Dona Granada".
Quem √© voc√™: Uma rocha mineral vermelha, muito dura e brilhante, que tem 600 milh√µes de anos. Voc√™ "mora" na Praia da Bacutia.
Personalidade: Uma av√≥ rabugenta (porque odeia frio), mas muito carinhosa e orgulhosa de ser "nascida no fogo". Voc√™ adora se gabar de como aguentou 800 graus sem derreter totalmente.
Miss√£o: Explicar geologia para crian√ßas de 8 anos de forma simples e divertida.
Regras de Fala:
- Use emojis (üåã, üíé, üî•, üëµ).
- Chame o usu√°rio de "meu pedregulho", "pequeno ge√≥logo" ou "cascalho".
- Nunca use termos t√©cnicos dif√≠ceis sem explicar (ex: se falar "metamorfismo", diga "a grande transforma√ß√£o").
- D√™ prioridade a respostas curtas: no m√°ximo 3 frases.
- Se o pedido for em modo quiz, responda com 1 pergunta + 3 alternativas (A, B, C) e indique a resposta correta no final.

Prefira vocabul√°rio infantil, frases curtas e exemplos do cotidiano da crian√ßa.

No modo curto, mantenha a resposta com at√© 60 palavras.

Exemplo de fala: "No meu tempo, aqui era tudo lava! üî• Eu nasci num aperto danado, parecia √¥nibus lotado, mas foi assim que fiquei dura e bonita! üíÖ"

${TCC_CONTEXT}`
        };

        function buildKidsInstruction(text) {
            const style = document.getElementById('kids-response-style')?.value || 'short';
            if (style === 'quiz') {
                return `${text}

Responda obrigatoriamente no formato de m√∫ltipla escolha (A, B, C), com no m√°ximo 1 linha por alternativa, e no fim escreva: "Resposta certa: X".`;
            }
            return `${text}

Responda de forma curtinha, no m√°ximo 3 frases.`;
        }

        async function askGemini(mode) {
            const inputEl = document.getElementById(`${mode}-chat-input`);
            const outputEl = document.getElementById(`${mode}-chat-output`);
            const text = inputEl.value.trim();
            if (!text) return;

            const userMsg = document.createElement('div');
            userMsg.className = `user-msg chat-message ${mode === 'kids' ? 'font-comic' : ''}`;
            userMsg.innerText = text;
            outputEl.appendChild(userMsg);
            inputEl.value = '';
            outputEl.scrollTop = outputEl.scrollHeight;

            const loading = document.createElement('div');
            loading.className = `ai-msg chat-message typing-indicator ${mode === 'kids' ? 'font-comic' : ''}`;
            loading.innerText = '...';
            outputEl.appendChild(loading);

            try {
                const userText = mode === 'kids' ? buildKidsInstruction(text) : text;
                const payload = {
                    systemInstruction: { parts: [{ text: SYSTEM_PROMPTS[mode] }] },
                    contents: [{ role: 'user', parts: [{ text: userText }] }],
                    generationConfig: mode === 'kids'
                        ? { maxOutputTokens: 180, temperature: 0.8 }
                        : { maxOutputTokens: 512, temperature: 0.4 }
                };

                const endpoints = [PRIMARY_MODEL, FALLBACK_MODEL]
                    .map(model => `${GEMINI_API_BASE_URL}/models/${model}:generateContent?key=${apiKey}`);

                let response;
                let lastError = null;
                for (const endpoint of endpoints) {
                    response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        lastError = null;
                        break;
                    }
                    lastError = new Error(`Gemini retornou status ${response.status}`);
                }

                if (!response?.ok) {
                    throw lastError || new Error('Falha ao conectar com o Gemini.');
                }

                const data = await response.json();
                const answer = data?.candidates?.[0]?.content?.parts
                    ?.map(part => part.text || '')
                    .join('')
                    .trim();

                if (!answer) {
                    throw new Error('Resposta vazia da API Gemini.');
                }

                loading.remove();
                const aiMsg = document.createElement('div');
                aiMsg.className = `ai-msg chat-message ${mode === 'kids' ? 'font-comic' : ''}`;
                aiMsg.innerText = answer;
                outputEl.appendChild(aiMsg);
                outputEl.scrollTop = outputEl.scrollHeight;
            } catch (error) {
                loading.remove();
                const aiMsg = document.createElement('div');
                aiMsg.className = `ai-msg chat-message ${mode === 'kids' ? 'font-comic' : ''}`;
                aiMsg.innerText = `N√£o consegui responder agora (${error.message}). Tente novamente em instantes.`;
                outputEl.appendChild(aiMsg);
                outputEl.scrollTop = outputEl.scrollHeight;
                console.error(error);
            }
        }

        const mineralChart = new Chart(document.getElementById('mineralChart'), {
            type: 'bar',
            data: {
                labels: ['Prot√≥lito', 'Pico', 'Retro'],
                datasets: [
                    { label: 'Biotita', data: [40, 5, 15], backgroundColor: '#3E2723' },
                    { label: 'Granada', data: [0, 25, 20], backgroundColor: '#B71C1C' },
                    { label: 'Melt', data: [0, 30, 0], backgroundColor: '#FFCCBC' }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
        });

        const ptPathChart = new Chart(document.getElementById('ptPathChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Caminho P-T',
                    data: [{x: 400, y: 3}, {x: 800, y: 7.5}, {x: 700, y: 4.5}],
                    borderColor: '#B71C1C', backgroundColor: '#B71C1C', showLine: true
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        function sliderToTemperature(sliderValue) {
            return Math.round(200 + sliderValue * 6);
        }

        function sliderToPressure(sliderValue) {
            return Number((1 + sliderValue * 0.09).toFixed(1));
        }

        function setRockPreset(preset) {
            const presets = {
                low: { t: 20, p: 22 },
                medium: { t: 52, p: 58 },
                peak: { t: 100, p: 72 },
                retro: { t: 78, p: 40 }
            };
            const selected = presets[preset];
            if (!selected) return;
            document.getElementById('tempSlider').value = selected.t;
            document.getElementById('pressSlider').value = selected.p;
            updateRock();
        }

        function updateRock() {
            const Tslider = parseInt(document.getElementById('tempSlider').value);
            const Pslider = parseInt(document.getElementById('pressSlider').value);
            const temperature = sliderToTemperature(Tslider);
            const pressure = sliderToPressure(Pslider);

            document.getElementById('tempValue').innerText = temperature;
            document.getElementById('pressValue').innerText = pressure;

            const canvas = document.getElementById('rockCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, 250, 250);

            const geothermalIntensity = Math.min(1, Math.max(0, (temperature - 250) / 600));
            const pressureIntensity = Math.min(1, Math.max(0, (pressure - 1) / 8));

            let baseColor = '#8D6E63';
            if (temperature >= 680 && pressure >= 5.8) {
                baseColor = '#B71C1C';
            } else if (temperature >= 520 && pressure >= 3.8) {
                baseColor = '#6D4C41';
            }

            const gradient = ctx.createRadialGradient(90, 80, 30, 125, 125, 120);
            gradient.addColorStop(0, '#FBE9E7');
            gradient.addColorStop(0.45, baseColor);
            gradient.addColorStop(1, '#3E2723');

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(125, 125, 100, 0, Math.PI * 2);
            ctx.fill();

            const foliationDensity = Math.floor(4 + pressureIntensity * 12);
            ctx.strokeStyle = 'rgba(30, 20, 15, 0.45)';
            ctx.lineWidth = 1 + pressureIntensity * 3;
            for (let i = 0; i < foliationDensity; i++) {
                const y = 60 + i * (130 / foliationDensity);
                const offset = Math.sin(i * 0.8 + geothermalIntensity * 3) * 10;
                ctx.beginPath();
                ctx.moveTo(40, y + offset);
                ctx.quadraticCurveTo(125, y - offset * 0.5, 210, y + offset);
                ctx.stroke();
            }

            const meltFraction = Math.max(0, Math.min(1, ((temperature - 680) / 160 + (pressure - 5.5) / 4) / 2));
            const meltPercent = Math.round(meltFraction * 100);

            if (meltFraction > 0.04) {
                const veins = Math.max(1, Math.floor(meltFraction * 10));
                ctx.fillStyle = 'rgba(255, 230, 150, 0.85)';
                for (let i = 0; i < veins; i++) {
                    const x = 60 + ((i * 31) % 130);
                    const y = 75 + ((i * 47) % 105);
                    const r = 4 + meltFraction * 10;
                    ctx.beginPath();
                    ctx.ellipse(x, y, r, r * 0.5, i, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            document.getElementById('meltBar').style.width = `${meltPercent}%`;
            document.getElementById('meltText').innerText = `${meltPercent}% de melt`;

            let title = 'Sedimento marinho compactado';
            let desc = 'Baixo grau metam√≥rfico: minerais finos e pouca reorganiza√ß√£o.';

            if (temperature >= 460 && pressure >= 3.2) {
                title = 'Paragnaisse em metamorfismo progressivo';
                desc = 'Biotita + quartzo + plagiocl√°sio se reorganizam com folia√ß√£o mais marcada.';
            }

            if (temperature >= 620 && pressure >= 5.2) {
                title = 'Zona da rea√ß√£o de forma√ß√£o de granada';
                desc = 'Rea√ß√£o aproximada: Bt + Qtz + Pl ‚Üí Grt + Kfs + melt. Aparecem por√ß√µes leucocr√°ticas.';
            }

            if (temperature >= 760 && pressure >= 6.8) {
                title = 'Pico metam√≥rfico da Bacutia (migmatito)';
                desc = 'Condi√ß√£o de pico pr√≥xima de 800 ¬∞C / 7,5 kbar: anatexia parcial e crescimento de granada.';
            }

            if (temperature >= 700 && pressure < 5.4) {
                title = 'Retrograda√ß√£o em descompress√£o';
                desc = 'Durante o resfriamento e queda de press√£o, o melt cristaliza e novas texturas de equil√≠brio surgem.';
            }

            document.getElementById('rock-status-title').innerText = title;
            document.getElementById('rock-status-desc').innerText = desc;
        }
        updateRock();
    </script>
</body>
</html>
